\chapter{Tests with nccopy}
\label{ch:nccopy}

\section{Introduction}


The nccopy utility copies an input NetCDF file to an output NetCDF file, in any of the four format variants, if possible.\footnote{\url{http://www.doc.ic.ac.uk/~rn710/Installs/netcdf-4.2/man4/html/guide_nccopy.html}}

The nccopy utility can be found in the directory

\begin{framed}
esdm-netcdf/build/ncdump/nccopy
\end{framed}

and the simplest way to call is

\begin{framed}
nccopy input\_file output\_file
\end{framed}

As we want to test if the files generated by ESDM are compatible with NetCDF, we are going to run four different tests, described in the next sections. To call ESDM, just insert \textbf{esdm://} before the file.

Before start the testing, it is also good to run the \textbf{mkfs.esdm} utility with the following parameters.

\begin{framed}
\$ mkfs.esdm --create --remove --ignore-errors -g -c \_esdm.conf
\end{framed}

Two files are being tested: smallfile.nc and bigfile.nc. These files are originally NetCDF files. Table \ref{tab:netcdf} has information about these files\footnote{\url{https://www.unidata.ucar.edu/software/netcdf/examples/files.html}}.

netcdf smallfile {
dimensions:
	lat = 1 ;
variables:
	float lat(lat) ;
	float lon(lat) ;
	int64 Elevation(lat, lat) ;
}

\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|}
\hline
\multicolumn{1}{|c|}{NetCDF File}	& \multicolumn{1}{|c|}{Size} & \multicolumn{1}{|c|}{Description} \\ \hline \hline
sresa1b\_ncar\_ccsm3-example.nc & 2.8 MB & From the Community Climate System Model (CCSM), one time step of precipitation flux, air temperature, and eastward wind. \\ \hline
test\_echam\_spectral.nc & 281.4 MB & Example model output from the ECHAM general circulation model. Almost CF, but not quite. Has a spectral coordinate for variables such as temperature (st) and vorticity (svo). \\ \hline
\hline
\end{tabular}
\caption{\label{tab:netcdf} Sample files following CF conventions.}
\end{table}

\section{Tests}


Copy the original NetCDF file to ESDM:

\begin{framed}
nccopy test\_echam\_spectral.nc esdm:\\test\_echam\_spectral\_out.nc
\end{framed}

Copy the ESDM file to NetCDF format:

\begin{framed}
nccopy esdm:\\test\_echam\_spectral\_out.nc test\_echam\_spectral\_final.nc
\end{framed}

Compare the initial and final files:

\begin{framed}
diff test\_echam\_spectral.nc test\_echam\_spectral\_final.nc
\end{framed}

All tests run without output.

\begin{verbatim}
lucy@lucy:~/esiwace/esdm-netcdf/build/ncdump$ ncdump smallfile.nc
netcdf smallfile {
dimensions:
	lat = 1 ;
variables:
	float lat(lat) ;
	float lon(lat) ;
	int64 Elevation(lat, lat) ;
data:

 lat = _ ;

 lon = _ ;

 Elevation =
  _ ;
}

ESDM has not been shutdown correctly. Stacktrace:
3: ncdump(+0x86f9) [0x562111c426f9]
4: /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xe7) [0x7f046adb9b97]
5: ncdump(+0x264a) [0x562111c3c64a]

lucy@lucy:~/esiwace/esdm-netcdf/build/ncdump$ .libs/nccopy smallfile.nc esdm://smallfile_out.esdm
0 = 1
0 = 1
0 = 1
0 = 1

ESDM has not been shutdown correctly. Stacktrace:
3: .libs/nccopy(+0x8c18) [0x5649b5b55c18]
4: /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xe7) [0x7f7da6109b97]
5: .libs/nccopy(+0x29ea) [0x5649b5b4f9ea]

lucy@lucy:~/esiwace/esdm-netcdf/build/ncdump/_metadummy/containers$ more smallfile_out.esdm.md
{"Variables":{"type":"o","data":null,"childs":{"_nc_dims":{"type":"q1@m","data":["lat"]},"_nc_sizes":{"type":"q1@i","da
ta":[1]}}},"dsets":[{"name":"lat","id":"eUyIKbbzj9Y0kEpk"},
{"name":"lon","id":"eUyIKbxOPzPXyKqL"},
{"name":"Elevation","id":"eUyIKbrJHZSAAnbt"}]}

lucy@lucy:~/esiwace/esdm-netcdf/build/ncdump/_metadummy/containers$ python -m json.tool smallfile_out.esdm.md
{
    "Variables": {
        "childs": {
            "_nc_dims": {
                "data": [
                    "lat"
                ],
                "type": "q1@m"
            },
            "_nc_sizes": {
                "data": [
                    1
                ],
                "type": "q1@i"
            }
        },
        "data": null,
        "type": "o"
    },
    "dsets": [
        {
            "id": "eUyIKbbzj9Y0kEpk",
            "name": "lat"
        },
        {
            "id": "eUyIKbxOPzPXyKqL",
            "name": "lon"
        },
        {
            "id": "eUyIKbrJHZSAAnbt",
            "name": "Elevation"
        }
    ]
}
\end{verbatim}

\begin{verbatim}
lucy@lucy:~/esiwace/esdm-netcdf/build/ncdump$ .libs/nccopy bigfile.nc esdm://bigfile_out.esdm

ESDM has not been shutdown correctly. Stacktrace:
3: .libs/nccopy(+0x8c18) [0x55a117c9fc18]
4: /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xe7) [0x7f6f430a4b97]
5: .libs/nccopy(+0x29ea) [0x55a117c999ea]
\end{verbatim}

nccopy esdm://input\_file output\_file

\begin{verbatim}


\end{verbatim}
